# Worker Report 1522: Build Regression Analysis

## Issue Summary

Commit 1521 introduced a build regression. The project fails to compile due to header incompatibility between the cbindgen-regenerated dterm.h and the existing Swift code.

## Root Cause

In commit 1521, the dterm.h header was regenerated using cbindgen. This:

1. **Removed manual header content** - The old header had `#define DTERM_FFI 1` and many manually-added type definitions under `#if defined(DTERM_FFI)` guards
2. **Changed header structure** - cbindgen generated a completely different header structure with different type names and without the FFI guards
3. **Broke Swift imports** - The Swift code expects specific FFI function signatures that no longer match

## Affected Files

- `DTermCore/include/dterm.h` - Header file regenerated by cbindgen
- `sources/DTermCore.swift` - Contains calls to FFI functions with old signatures
- `sources/DTermCoreIntegration.swift` - Depends on DTermCore
- `sources/DTermCoreParserAdapter.swift` - References parser callback types that don't exist

## Symptoms

Build fails with errors like:
```
cannot find type 'dterm_cell_t' in scope
cannot find 'dterm_terminal_new' in scope
cannot find 'PRINT' in scope
cannot find 'dterm_parser_new' in scope
```

## Working State

Commit 444ffeba5 (1520) builds successfully:
```bash
git checkout 444ffeba5 -- DTermCore/include/dterm.h DTermCore/lib/libdterm_core.a sources/DTermCore.swift
```

## Fix Options

### Option 1: Restore Old Header (Quick Fix)
Restore dterm.h from commit 444ffeba5. This loses the new scrollback cell functions added in 1521.

### Option 2: Manual Header Maintenance (Recommended)
1. Keep the old-style header with `#define DTERM_FFI 1` guards
2. Manually add new FFI declarations to the header
3. Don't regenerate the entire header with cbindgen
4. Update cbindgen.toml to append new functions instead of replacing

### Option 3: Migrate to New Header Style (Breaking Change)
1. Accept the new cbindgen header format
2. Update all Swift code to match new function signatures
3. This requires significant Swift code changes

## Recommended Next Steps

1. Revert dterm.h to 444ffeba5 version
2. Manually add only the new scrollback functions to the header
3. Test that all existing functionality still works
4. Create a script to safely update the header without breaking compatibility

## Files to Reference

- Old working header: `git show 444ffeba5:DTermCore/include/dterm.h`
- New (broken) header: `git show 6562eb2d7:DTermCore/include/dterm.h`
- Rust FFI source: `dashterm-core/src/ffi/mod.rs`
