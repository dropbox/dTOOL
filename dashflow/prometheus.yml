# Prometheus scrape configuration for DashFlow Rust apps
#
# Usage:
#   docker run -p 9090:9090 -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
#
# Then visit http://localhost:9090 to query metrics
#
# Host Scraping Portability:
#   This config uses `host.docker.internal` to scrape apps running on the host.
#   - Mac/Windows: Works natively with Docker Desktop
#   - Linux: Requires `extra_hosts: ["host.docker.internal:host-gateway"]` in docker-compose
#            (already configured in docker-compose.dashstream.yml)
#   - Standalone: docker run --add-host=host.docker.internal:host-gateway ...

global:
  scrape_interval: 15s     # Scrape targets every 15 seconds
  evaluation_interval: 15s # Evaluate rules every 15 seconds

# Alert rule files
rule_files:
  - 'alert_rules.yml'

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['dashstream-alertmanager:9093']

# Scrape configurations
scrape_configs:
  # DashFlow Streaming prometheus-exporter (quality metrics from Kafka)
  - job_name: 'dashstream-quality'
    static_configs:
      - targets: ['dashstream-prometheus-exporter:9190']
        labels:
          service: 'dashstream'
          component: 'prometheus-exporter'
          environment: 'development'

  # DashFlow Streaming websocket-server (infrastructure metrics)
  - job_name: 'dashstream-infrastructure'
    static_configs:
      - targets: ['dashstream-websocket-server:3002']
        labels:
          service: 'dashstream'
          component: 'websocket-server'
          environment: 'development'

  # Example app scrape configs - uses host.docker.internal for Docker compatibility
  # These scrape apps running on the host machine from inside Docker

  # librarian app (Ultimate RAG Paragon)
  # Note: Example apps have been consolidated into librarian
  - job_name: 'librarian'
    static_configs:
      - targets: ['host.docker.internal:9091']
        labels:
          app: 'librarian'
          environment: 'development'

# Example PromQL queries (using librarian as example):
#
# Request rate (requests per second):
#   rate(librarian_requests_total[1m])
#
# Request duration p50/p95/p99:
#   histogram_quantile(0.50, rate(librarian_request_duration_seconds_bucket[5m]))
#   histogram_quantile(0.95, rate(librarian_request_duration_seconds_bucket[5m]))
#   histogram_quantile(0.99, rate(librarian_request_duration_seconds_bucket[5m]))
#
# Error rate:
#   rate(librarian_errors_total[1m])
#
# Token usage:
#   rate(librarian_llm_tokens_total[1m])
#
# Quality scores (average):
#   avg(librarian_quality_score)
